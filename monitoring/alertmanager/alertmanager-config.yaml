# AlertManager Configuration for EventSphere
# Configures alert routing and notifications via AWS SNS

---
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-eventsphere
  namespace: monitoring
  labels:
    app: alertmanager
type: Opaque
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m
      # Slack webhook URL (optional - uncomment if using Slack)
      # slack_api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'
    
    # Templates for notifications
    templates:
      - '/etc/alertmanager/config/*.tmpl'
    
    # Inhibition rules - prevent notification spam
    inhibit_rules:
      # If a critical alert fires, silence warnings for the same alertname
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'namespace', 'pod']
      
      # If service is down, silence latency alerts
      - source_match:
          alertname: 'ServiceDown'
        target_match_re:
          alertname: '(HighLatency.*|HighErrorRate)'
        equal: ['app']
    
    # Routing tree
    route:
      # Default receiver
      receiver: 'default-receiver'
      
      # Group alerts by these labels
      group_by: ['alertname', 'severity', 'namespace', 'app']
      
      # Wait before sending first notification for a group
      group_wait: 30s
      
      # Wait before sending notifications about new alerts in a group
      group_interval: 5m
      
      # Wait before re-sending a notification
      repeat_interval: 4h
      
      # Child routes
      routes:
        # Critical alerts - immediate notification
        - match:
            severity: critical
          receiver: 'critical-sns'
          group_wait: 10s
          group_interval: 1m
          repeat_interval: 1h
          continue: true
        
        # Warning alerts
        - match:
            severity: warning
          receiver: 'warning-sns'
          group_wait: 1m
          group_interval: 5m
          repeat_interval: 4h
        
        # Database team alerts
        - match:
            team: database
          receiver: 'database-team'
          continue: true
        
        # Platform team alerts (default)
        - match:
            team: platform
          receiver: 'platform-team'
    
    # Receivers define notification integrations
    receivers:
      # Default receiver (placeholder)
      - name: 'default-receiver'
        # Add webhook or other receiver here
      
      # Critical alerts via SNS
      - name: 'critical-sns'
        sns_configs:
          - topic_arn: 'arn:aws:sns:us-east-1:${AWS_ACCOUNT_ID}:eventsphere-critical-alerts'
            sigv4:
              region: us-east-1
            subject: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
            message: |
              üö® *CRITICAL ALERT* üö®
              
              *Alert:* {{ .GroupLabels.alertname }}
              *Severity:* {{ .CommonLabels.severity }}
              *Namespace:* {{ .CommonLabels.namespace }}
              *App:* {{ .CommonLabels.app }}
              
              *Summary:* {{ .CommonAnnotations.summary }}
              *Description:* {{ .CommonAnnotations.description }}
              
              *Runbook:* {{ .CommonAnnotations.runbook_url }}
              
              *Firing Alerts:*
              {{ range .Alerts.Firing }}
              - {{ .Labels.alertname }}: {{ .Annotations.description }}
              {{ end }}
            attributes:
              severity: critical
              source: alertmanager
      
      # Warning alerts via SNS
      - name: 'warning-sns'
        sns_configs:
          - topic_arn: 'arn:aws:sns:us-east-1:${AWS_ACCOUNT_ID}:eventsphere-alerts'
            sigv4:
              region: us-east-1
            subject: '‚ö†Ô∏è WARNING: {{ .GroupLabels.alertname }}'
            message: |
              ‚ö†Ô∏è *Warning Alert*
              
              *Alert:* {{ .GroupLabels.alertname }}
              *Severity:* {{ .CommonLabels.severity }}
              *Namespace:* {{ .CommonLabels.namespace }}
              *App:* {{ .CommonLabels.app }}
              
              *Summary:* {{ .CommonAnnotations.summary }}
              *Description:* {{ .CommonAnnotations.description }}
              
              *Firing Alerts:*
              {{ range .Alerts.Firing }}
              - {{ .Labels.alertname }}: {{ .Annotations.description }}
              {{ end }}
            attributes:
              severity: warning
              source: alertmanager
      
      # Database team notifications
      - name: 'database-team'
        sns_configs:
          - topic_arn: 'arn:aws:sns:us-east-1:${AWS_ACCOUNT_ID}:eventsphere-database-alerts'
            sigv4:
              region: us-east-1
            subject: 'üóÑÔ∏è Database Alert: {{ .GroupLabels.alertname }}'
            message: |
              üóÑÔ∏è *Database Alert*
              
              *Alert:* {{ .GroupLabels.alertname }}
              *Severity:* {{ .CommonLabels.severity }}
              
              *Description:* {{ .CommonAnnotations.description }}
              
              {{ range .Alerts.Firing }}
              - {{ .Annotations.description }}
              {{ end }}
      
      # Platform team notifications
      - name: 'platform-team'
        sns_configs:
          - topic_arn: 'arn:aws:sns:us-east-1:${AWS_ACCOUNT_ID}:eventsphere-alerts'
            sigv4:
              region: us-east-1
            subject: 'üìä Platform Alert: {{ .GroupLabels.alertname }}'
            message: |
              üìä *Platform Alert*
              
              *Alert:* {{ .GroupLabels.alertname }}
              *Severity:* {{ .CommonLabels.severity }}
              *Namespace:* {{ .CommonLabels.namespace }}
              
              *Description:* {{ .CommonAnnotations.description }}
              
              {{ range .Alerts.Firing }}
              - {{ .Annotations.description }}
              {{ end }}

---
# AlertManager notification templates
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-templates
  namespace: monitoring
data:
  default.tmpl: |
    {{ define "slack.default.title" }}
    [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}
    {{ end }}

    {{ define "slack.default.text" }}
    {{ range .Alerts }}
    *Alert:* {{ .Annotations.summary }}
    *Description:* {{ .Annotations.description }}
    *Severity:* {{ .Labels.severity }}
    *Details:*
      {{ range .Labels.SortedPairs }} ‚Ä¢ *{{ .Name }}:* `{{ .Value }}`
      {{ end }}
    {{ end }}
    {{ end }}

    {{ define "email.default.subject" }}
    [{{ .Status | toUpper }}] {{ .CommonLabels.alertname }} - EventSphere
    {{ end }}

    {{ define "email.default.html" }}
    <!DOCTYPE html>
    <html>
    <head>
      <style>
        body { font-family: Arial, sans-serif; }
        .alert { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .critical { background-color: #ffebee; border-left: 4px solid #f44336; }
        .warning { background-color: #fff3e0; border-left: 4px solid #ff9800; }
        .info { background-color: #e3f2fd; border-left: 4px solid #2196f3; }
      </style>
    </head>
    <body>
      <h2>EventSphere Alert Notification</h2>
      {{ range .Alerts }}
      <div class="alert {{ .Labels.severity }}">
        <h3>{{ .Labels.alertname }}</h3>
        <p><strong>Summary:</strong> {{ .Annotations.summary }}</p>
        <p><strong>Description:</strong> {{ .Annotations.description }}</p>
        <p><strong>Severity:</strong> {{ .Labels.severity }}</p>
        <p><strong>Namespace:</strong> {{ .Labels.namespace }}</p>
        <p><strong>App:</strong> {{ .Labels.app }}</p>
      </div>
      {{ end }}
    </body>
    </html>
    {{ end }}

